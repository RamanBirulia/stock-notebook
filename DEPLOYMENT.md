# Deployment Guide: Digital Ocean App Platform

This guide will walk you through deploying your Stock Tracker application to Digital Ocean App Platform. The application consists of a React frontend and a Rust backend with SQLite database.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Preparation](#preparation)
3. [Digital Ocean Setup](#digital-ocean-setup)
4. [Environment Variables](#environment-variables)
5. [Deployment Options](#deployment-options)
6. [Post-Deployment](#post-deployment)
7. [Monitoring & Maintenance](#monitoring--maintenance)
8. [Troubleshooting](#troubleshooting)

## Prerequisites

### Required Accounts
- **GitHub Account**: Your code must be in a GitHub repository
- **Digital Ocean Account**: Sign up at [digitalocean.com](https://digitalocean.com)
- **Alpha Vantage Account**: Get your free API key at [alphavantage.co](https://alphavantage.co)

### Required Tools
- Git
- Node.js 18+
- Rust 1.70+ (for local testing)

## Preparation

### 1. Push Your Code to GitHub

Make sure your repository is pushed to GitHub and accessible:

```bash
git add .
git commit -m "Prepare for Digital Ocean deployment"
git push origin main
```

### 2. Update Repository URL

Edit `.do/app.yaml` and replace `your-username/stock-notebook` with your actual GitHub repository:

```yaml
github:
  repo: your-username/your-repository-name
  branch: main
```

### 3. Environment Variables Setup

You'll need these environment variables for production:

#### Backend Variables
- `DATABASE_URL` - Database connection string
- `ALPHA_VANTAGE_API_KEY` - Your Alpha Vantage API key
- `JWT_SECRET` - Secret key for JWT tokens (generate a secure one)
- `FRONTEND_URL` - Your frontend URL (will be provided by DO)
- `PORT` - Port number (default: 8080)
- `RUST_LOG` - Log level (recommended: info)

#### Frontend Variables
- `REACT_APP_API_URL` - Backend API URL (will be provided by DO)

## Digital Ocean Setup

### Option 1: Using the Web Interface (Recommended)

1. **Login to Digital Ocean**
   - Go to [cloud.digitalocean.com](https://cloud.digitalocean.com)
   - Navigate to "Apps" in the sidebar

2. **Create New App**
   - Click "Create App"
   - Choose "GitHub" as source
   - Connect your GitHub account if not already connected
   - Select your repository and branch

3. **Configure App Settings**
   - Digital Ocean will auto-detect your app structure
   - Review the detected services (should show React and Rust components)

4. **Set Environment Variables**
   - In the app configuration, add all required environment variables
   - Mark sensitive variables (API keys, secrets) as "encrypted"

5. **Choose Plan**
   - Basic plan is sufficient for development/testing
   - Pro plan recommended for production traffic

6. **Deploy**
   - Review configuration and click "Create Resources"

### Option 2: Using the App Spec (Advanced)

1. **Prepare App Spec**
   - The `.do/app.yaml` file contains your app configuration
   - Review and customize as needed

2. **Deploy via CLI**
   ```bash
   # Install doctl CLI
   snap install doctl
   # or: brew install doctl

   # Authenticate
   doctl auth init

   # Create app from spec
   doctl apps create --spec .do/app.yaml
   ```

## Environment Variables

### Setting Up Environment Variables

#### 1. Generate JWT Secret
```bash
# Generate a secure random string
openssl rand -base64 32
```

#### 2. Configure in Digital Ocean
In your app settings, add these environment variables:

```
DATABASE_URL=${db.DATABASE_URL}  # Auto-generated by DO
ALPHA_VANTAGE_API_KEY=your_actual_api_key_here
JWT_SECRET=your_generated_jwt_secret_here
FRONTEND_URL=${frontend.PUBLIC_URL}  # Auto-generated by DO
PORT=8080
RUST_LOG=info
REACT_APP_API_URL=${backend.PUBLIC_URL}  # Auto-generated by DO
```

#### 3. Environment Variable Types
- **Plain Text**: Non-sensitive configuration
- **Secret**: Sensitive data (API keys, database passwords)
- **System Generated**: Auto-generated by Digital Ocean

## Deployment Options

### Database Options

#### Option A: PostgreSQL Database (Recommended)
- Use Digital Ocean's managed PostgreSQL
- Automatically backed up and maintained
- Better for production workloads

Update your backend to support PostgreSQL:

```toml
# Add to Cargo.toml
[dependencies]
sqlx = { version = "0.7", features = [
    "runtime-tokio-rustls",
    "postgres",  # Add this
    "sqlite",
    "chrono",
    "uuid",
] }
```

#### Option B: SQLite with Volume
- Use persistent volume for SQLite database
- Simpler setup but less scalable

### Frontend Deployment Options

#### Option A: Static Site (Recommended)
- Faster loading, better caching
- More cost-effective
- Ideal for React SPAs

#### Option B: Node.js Service
- More control over serving
- Useful for server-side rendering
- Higher resource usage

## Post-Deployment

### 1. Verify Deployment

After deployment, check:

#### Health Endpoints
```bash
# Backend health check
curl https://your-backend-url.ondigitalocean.app/health

# Frontend access
curl https://your-frontend-url.ondigitalocean.app
```

#### Database Connection
- Check logs for successful database connection
- Verify migrations ran successfully

### 2. Test Core Functionality

1. **User Registration**
   - Create a test account
   - Verify JWT token generation

2. **Stock Data**
   - Test stock symbol search
   - Verify Alpha Vantage API integration

3. **Portfolio Management**
   - Add sample stock purchases
   - Check dashboard calculations

### 3. Configure Custom Domain (Optional)

1. **Add Domain in Digital Ocean**
   - Go to App settings → Domains
   - Add your custom domain

2. **Update DNS**
   - Point your domain to Digital Ocean's nameservers
   - Configure A records as instructed

3. **SSL Certificate**
   - Digital Ocean automatically provisions SSL certificates
   - Verify HTTPS is working

## Monitoring & Maintenance

### 1. Monitoring

#### Application Logs
```bash
# View logs via CLI
doctl apps logs <app-id> --type run

# Or use the web interface
# Apps → Your App → Runtime Logs
```

#### Performance Metrics
- Monitor CPU and memory usage
- Track response times
- Set up alerts for high error rates

### 2. Scaling

#### Horizontal Scaling
```yaml
# In app.yaml
services:
  - name: backend
    instance_count: 2  # Scale to 2 instances
```

#### Vertical Scaling
```yaml
# In app.yaml
services:
  - name: backend
    instance_size_slug: basic-xs  # Upgrade instance size
```

### 3. Database Maintenance

#### Backups
- Digital Ocean automatically backs up managed databases
- Configure backup retention policy

#### Performance Monitoring
- Monitor database connection pool
- Watch for slow queries

## Troubleshooting

### Common Issues

#### 1. Build Failures

**Rust Build Issues**
```bash
# Check build logs for missing dependencies
# Common fixes:
- Ensure all system dependencies are installed
- Check Rust version compatibility
- Verify Cargo.toml dependencies
```

**React Build Issues**
```bash
# Common fixes:
- Clear node_modules and reinstall
- Check Node.js version compatibility
- Verify environment variables are set
```

#### 2. Runtime Issues

**CORS Errors**
- Verify `FRONTEND_URL` environment variable
- Check CORS configuration in backend
- Ensure both HTTP and HTTPS URLs are handled

**Database Connection Issues**
- Verify `DATABASE_URL` is correctly set
- Check database service is running
- Review migration logs

**API Integration Issues**
- Verify `ALPHA_VANTAGE_API_KEY` is set
- Check API rate limits
- Review API response logs

#### 3. Performance Issues

**Slow Response Times**
- Check database query performance
- Monitor API rate limits
- Consider implementing caching

**High Memory Usage**
- Monitor Rust application memory usage
- Check for memory leaks in request handlers
- Consider upgrading instance size

### Getting Help

#### Digital Ocean Support
- Documentation: [docs.digitalocean.com](https://docs.digitalocean.com)
- Community: [digitalocean.com/community](https://digitalocean.com/community)
- Support tickets: Available with paid plans

#### Application Logs
```bash
# Backend logs
doctl apps logs <app-id> --type run --component backend

# Frontend logs
doctl apps logs <app-id> --type run --component frontend

# Build logs
doctl apps logs <app-id> --type build
```

## Cost Optimization

### 1. Right-sizing
- Start with basic instances
- Monitor usage and scale as needed
- Use horizontal scaling for traffic spikes

### 2. Database Optimization
- Choose appropriate database size
- Monitor connection pool usage
- Consider read replicas for high traffic

### 3. Frontend Optimization
- Use static site deployment when possible
- Enable gzip compression
- Optimize build bundle size

## Security Best Practices

### 1. Environment Variables
- Never commit secrets to git
- Use Digital Ocean's encrypted environment variables
- Rotate API keys regularly

### 2. Database Security
- Use strong database passwords
- Enable SSL connections
- Restrict database access to app components only

### 3. Application Security
- Keep dependencies updated
- Use HTTPS everywhere
- Implement proper input validation

## Backup and Recovery

### 1. Database Backups
- Configure automated backups
- Test restore procedures
- Document recovery steps

### 2. Application Code
- Maintain Git repository backups
- Tag release versions
- Document deployment procedures

### 3. Configuration Backup
- Export app configuration
- Document environment variables
- Keep deployment scripts updated

---

## Quick Deployment Checklist

- [ ] Code pushed to GitHub
- [ ] Alpha Vantage API key obtained
- [ ] Digital Ocean account set up
- [ ] Repository URL updated in app.yaml
- [ ] Environment variables configured
- [ ] App deployed via Digital Ocean interface
- [ ] Health endpoints tested
- [ ] Core functionality verified
- [ ] Monitoring configured
- [ ] Custom domain configured (optional)

## Support

For issues specific to this application:
1. Check the application logs first
2. Review this troubleshooting guide
3. Check the main README.md for application-specific help
4. Open an issue in the GitHub repository

For Digital Ocean platform issues:
1. Check Digital Ocean documentation
2. Search Digital Ocean community forums
3. Contact Digital Ocean support (paid plans)

---

**Note**: This deployment guide assumes basic familiarity with Digital Ocean and cloud deployments. For detailed Digital Ocean App Platform documentation, visit [docs.digitalocean.com/products/app-platform](https://docs.digitalocean.com/products/app-platform/).